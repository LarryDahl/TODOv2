from __future__ import annotations

import aiosqlite
from pathlib import Path


SCHEMA_SQL = """
PRAGMA journal_mode=WAL;
PRAGMA foreign_keys=ON;

CREATE TABLE IF NOT EXISTS doto_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL,

    title TEXT NOT NULL,

    -- points: 1..100+ (ei ylärajaa pakoteta, mutta pidetään järkevänä)
    points INTEGER NOT NULL DEFAULT 1,

    -- priority: 0=Ei kiirettä, 1=Neutraali, 2=Tärkeä
    priority INTEGER NOT NULL DEFAULT 1,

    -- optional category (Koti/Terveys/Työ/Raha/Muut)
    category TEXT,

    -- state: active/done/deleted/upcoming
    status TEXT NOT NULL DEFAULT 'active',

    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL,

    done_at TEXT,
    deleted_at TEXT,
    delete_reason TEXT,

    deadline_at TEXT,
    scheduled_at TEXT
);

CREATE INDEX IF NOT EXISTS idx_doto_tasks_chat_status ON doto_tasks(chat_id, status);
CREATE INDEX IF NOT EXISTS idx_doto_tasks_chat_deadline ON doto_tasks(chat_id, deadline_at);
CREATE INDEX IF NOT EXISTS idx_doto_tasks_chat_scheduled ON doto_tasks(chat_id, scheduled_at);
CREATE INDEX IF NOT EXISTS idx_doto_tasks_chat_done_at ON doto_tasks(chat_id, done_at);

-- Undo stack (max 10 per chat)
CREATE TABLE IF NOT EXISTS doto_undo (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL,
    task_id INTEGER NOT NULL,
    event_type TEXT NOT NULL,  -- 'done' | 'delete'

    prev_status TEXT NOT NULL,
    prev_done_at TEXT,
    prev_deleted_at TEXT,
    prev_delete_reason TEXT,

    created_at TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_doto_undo_chat_created ON doto_undo(chat_id, created_at);

-- Optional: store user notes per task event (poikkeukset)
CREATE TABLE IF NOT EXISTS doto_task_notes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL,
    task_id INTEGER NOT NULL,
    note TEXT NOT NULL,
    created_at TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_doto_notes_chat_task ON doto_task_notes(chat_id, task_id);

-- Suggestions catalog (per chat, mutta voit myös tehdä global catalog chat_id=0)
CREATE TABLE IF NOT EXISTS doto_suggestions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL,
    title TEXT NOT NULL,
    difficulty_5 INTEGER NOT NULL DEFAULT 1, -- näytetään ehdotusnapissa (1..5)
    points INTEGER NOT NULL DEFAULT 1,
    priority INTEGER NOT NULL DEFAULT 1,
    category TEXT,
    is_active INTEGER NOT NULL DEFAULT 1
);

CREATE INDEX IF NOT EXISTS idx_doto_sugg_chat_active ON doto_suggestions(chat_id, is_active);

CREATE TABLE IF NOT EXISTS doto_suggestion_events (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chat_id INTEGER NOT NULL,
    suggestion_id INTEGER NOT NULL,
    created_at TEXT NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_doto_sugg_events_chat_time ON doto_suggestion_events(chat_id, created_at);
"""


class DotoDb:
    def __init__(self, db_path: str) -> None:
        self.db_path = db_path

    async def connect(self) -> aiosqlite.Connection:
        conn = await aiosqlite.connect(self.db_path)
        conn.row_factory = aiosqlite.Row
        return conn

    async def ensure_schema(self) -> None:
        Path(self.db_path).parent.mkdir(parents=True, exist_ok=True)
        async with await self.connect() as conn:
            await conn.executescript(SCHEMA_SQL)
            await conn.commit()
